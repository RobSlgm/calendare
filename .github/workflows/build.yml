name: ðŸ­ Build Calendare Server

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - release/**
  #     - main
  # pull_request:
  #   branches:
  #     - main

env:
  REGISTRY: ghcr.io
  CHART_REPO: charts

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x

      - uses: dotnet/nbgv@v0.4.2
        id: meta
        with:
          setAllVars: true

      - name: Prepare lower case names
        id: migr
        run: |
          REPOSITORY_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_lc=$REPOSITORY_LC" >> $GITHUB_OUTPUT
          REPOSITORY_OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repository_owner_lc=$REPOSITORY_OWNER_LC" >> $GITHUB_OUTPUT

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish server container to registry
        env:
          REPOSITORY_LC: ${{ steps.migr.outputs.repository_lc }}
          IMAGE_NAME: "calendare-server"
        run: |
          dotnet publish --os linux --arch x64 /t:PublishContainer \
            /p:ContainerImageTags='"${{ steps.meta.outputs.SemVer2 }};${{ steps.meta.outputs.MajorMinorVersion }};${{ steps.meta.outputs.Version }};latest"' \
            -p ContainerRegistry=${{ env.REGISTRY }} \
            -p ContainerRepository=${REPOSITORY_LC}/${IMAGE_NAME}

      - name: Build database migration
        working-directory: Data
        run: |
          dotnet tool install dotnet-ef
          dotnet ef migrations bundle --self-contained -r linux-x64 --force -o ../artifacts/efbundle

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push database migration container image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile.migration
          push: true
          # sbom: true
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.GitCommitDate }}
            SEMVER2=${{ steps.meta.outputs.SemVer2 }}
          tags: |
            ${{ env.REGISTRY }}/${{ steps.migr.outputs.repository_lc }}/calendare-migration:latest
            ${{ env.REGISTRY }}/${{ steps.migr.outputs.repository_lc }}/calendare-migration:${{ steps.meta.outputs.SemVer2 }}
            ${{ env.REGISTRY }}/${{ steps.migr.outputs.repository_lc }}/calendare-migration:${{ steps.meta.outputs.MajorMinorVersion }}
            ${{ env.REGISTRY }}/${{ steps.migr.outputs.repository_lc }}/calendare-migration:${{ steps.meta.outputs.Version }}

      - name: Push Helm chart
        env:
          VERSION: ${{ steps.meta.outputs.SemVer2 }}
          REPOSITORY_OWNER_LC: ${{ steps.migr.outputs.repository_owner_lc }}
        run: |
          helm package ./deploy --version "$VERSION" --app-version "$VERSION"
          helm push calendare-${VERSION}.tgz oci://${{ env.REGISTRY }}/${REPOSITORY_OWNER_LC}/${{ env.CHART_REPO }}
