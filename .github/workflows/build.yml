# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
name: üè≠ Build Calendare Server

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main
  # pull_request:
  #   branches:
  #     - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  MIGRATION_IMAGE_NAME: "calendare.migration"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x

      - uses: dotnet/nbgv@v0.4.2
        id: meta
        with:
          setAllVars: true

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish server container to registry
        run: |
          dotnet publish --os linux --arch x64 /t:PublishContainer \
            /p:ContainerImageTags='"${{ steps.meta.outputs.SemVer2 }};${{ steps.meta.outputs.MajorMinorVersion }};${{ steps.meta.outputs.Version }};latest"' \
            -p ContainerRegistry=ghcr.io \
            -p ContainerRepository=${{ env.IMAGE_NAME }}

      - name: Build database migration
        working-directory: Data
        run: |
          dotnet tool install dotnet-ef
          dotnet ef migrations bundle --self-contained -r linux-x64 --force -o ../artifacts/efbundle

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push database migration container image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile.migration
          push: true
          # sbom: true
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.GitCommitDate }}
            SEMVER2=${{ steps.meta.outputs.SemVer2 }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.MIGRATION_IMAGE_NAME}}:latest
            ${{ env.REGISTRY }}/${{ env.MIGRATION_IMAGE_NAME}}:${{ steps.meta.outputs.SemVer2 }}
            ${{ env.REGISTRY }}/${{ env.MIGRATION_IMAGE_NAME}}:${{ steps.meta.outputs.MajorMinorVersion }}
            ${{ env.REGISTRY }}/${{ env.MIGRATION_IMAGE_NAME}}:${{ steps.meta.outputs.Version }}

      # NO helm in gitea action runner
      # - name: Push Helm chart
      #   env:
      #     VERSION: ${{ steps.meta.outputs.SemVer2 }}
      #   run: |
      #     REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
      #     helm package ./deploy --version "$VERSION" --app-version "$VERSION"
      #     helm push calendare-server-${VERSION}.tgz oci://registry.slgm.ch/helm
